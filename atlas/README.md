# SQL マイグレーション管理

Atlas https://atlasgo.io/docs

## セットアップ

インストール

```bash
curl -sSf https://atlasgo.sh | sh
```

シーケンスとかマテビューのマイグレーションを使うのには、ログインが必要
bonos という組織を作成したので、管理者に招待してもらってからログインをしてください。

```bash
atlas login bonos
```

## テーブルの変更

https://atlasgo.io/declarative/apply
Declative Workflows という方法で管理を行なっています。

`./schema.hcl`にテーブルの構成がまとまっているので、変更してください。

変更内容の確認を以下のコマンドを行えます。
記述が間違っていればエラーがでます。

```bash
make migrate-diff
> -- Create "users" table
> CREATE TABLE "public"."users" ("id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY, "name" > character varying(255) NOT NULL, PRIMARY KEY ("id"));
```

問題なければ DB に変更を反映します。

```bash
make migrate

? Are you sure?:
  ▸ Apply
    Lint and edit
    Abort

✔ Apply
```

## Seed

初期データを入れれるように seed の仕組みも構築した。

`./seeds/development`に seed データを置いている。

### 作成

新たに seed ファイルを作成したい場合は以下のようなコマンドを実行する

```bash
atlas migrate new --dir "file://atlas/seeds/development" SEED_NAME
```

すると、`20240628144146_SEED_NAME.sql`というファイルが生成されるので、その中に Seed 用の INSERT 文を記述する。

反映は以下のコマンドを実行する。

```bash
make seed
```

### 編集

seed ファイルを編集することも可能。

値を変更したり、カラムを追加したりしたい場合は、既存の seed ファイルを編集する。

```diff
+    (1, 2, 'sample') on conflict (id) do
-    (1, 1, 'sample') on conflict (id) do
```

反映は以下のコマンドを実行する。

```bash
make seed
```
